<?xml version="1.0" encoding="utf-8" ?>
<mdscript name="KC_Extra_Commands" 
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!--
  Create some extra key-press activated commands.
  Acts as an example of using the key capture api, as well as hopefully
  being useful.
  
  Ideas:
  disable_collisions_between : turn on/off collision with player and target
  -->

  <cues>
    <!-- Register keys with the key capture api. -->
    <cue name="Register_Keys" instantiate="true">
      <conditions>
        <event_cue_signalled cue="md.Key_Capture.Reloaded" />
      </conditions>
      <actions>
        
        <!-- Register shortcuts. -->
        <signal_cue_instantly cue="md.Key_Capture.Register_Shortcut" param="table[
          $id = 'kc_target_follow', 
          $onPress = Target_Follow,
          $name = 'Follow Target', 
          $description = 'Turns on autopilot to follow the target',
          $contexts = ['flying'],
          ]"/>

        <signal_cue_instantly cue="md.Key_Capture.Register_Shortcut" param="table[
          $id = 'kc_eject_illegals', 
          $onPress = Eject_Illegals,
          $name = 'Eject Illegal Wares', 
          $description = 'Eject any player inventory or piloted ship cargo that is illegal in the player zone',
          $contexts = ['flying'],
          ]"/>
        
      </actions>
    </cue>
    
    <!-- Auto-follow target ship. -->
    <cue name="Target_Follow" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled/>
        <!-- Verify the player has a target selected. -->
        <check_value value="player.target"/>
        <!-- Verify the player is piloting a ship.-->
        <!-- TODO: check this in key capture api instead (space/flying context).-->
        <check_value value="player.occupiedship"/>
      </conditions>
      <actions>
        <!-- Debug message. -->
        <!--<raise_lua_event name="'directChatMessageReceived'" param="'KeyCapture;Starting Target_Follow'"/>--> 
                
        <!-- Cancel autopilot if the target is already the current dest.-->
        <do_if value="player.target == player.autopilottarget">
          <stop_player_autopilot />
          <show_notification text="{10002, 921}" comment="Autopilot Disengaged"/>
        </do_if>
        <!-- Start autopiloting to target. Should continuously follow. -->
        <do_else>
          <start_player_autopilot destination="player.target"/>
          <!-- This already puts up a notification on its own. -->
        </do_else>
      </actions>
    </cue>

    <!-- Drop illegal wares. -->
    <cue name="Eject_Illegals" instantiate="true" namespace="this">
      <conditions>
        <event_cue_signalled/>
        <!-- Verify the player is piloting a ship.-->
        <check_value value="player.occupiedship"/>
      </conditions>
      <actions>
        <!-- Debug message. -->
        <!--<raise_lua_event name="'directChatMessageReceived'" param="'KeyCapture;Ejecting_Illegals'"/>-->

        <set_value name="$faction" exact="player.zone.policefaction"/>
        <drop_illegal_cargo groupname="$boxes" object="player.occupiedship" faction="$faction"/>
        <drop_illegal_inventory groupname="$boxes" object="player.entity" faction="$faction"/>
        <do_if value="$boxes.count != 0">
          <show_notification text="'Ejected Illegal Wares'"/>
        </do_if>
        <do_else>
          <show_notification text="'No Illegal Wares'"/>          
        </do_else>
        
      </actions>
    </cue>


  </cues>

</mdscript>